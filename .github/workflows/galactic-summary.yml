name: Galactic Summary Generator

on:
  schedule:
    - cron: '0 9 * * 0'  # Weekly: Sunday 9 AM UTC
  workflow_dispatch:
    inputs:
      period:
        description: 'Summary period'
        required: true
        default: 'weekly'
        type: choice
        options:
          - weekly
          - monthly
          - yearly
      custom_start:
        description: 'Custom start date (YYYY-MM-DD)'
        required: false
      custom_end:
        description: 'Custom end date (YYYY-MM-DD)'
        required: false

jobs:
  generate-summary:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Generate summary
        run: |
          python scripts/generate_summary.py \
            --period ${{ inputs.period || 'weekly' }} \
            ${{ inputs.custom_start && format('--start {0}', inputs.custom_start) || '' }} \
            ${{ inputs.custom_end && format('--end {0}', inputs.custom_end) || '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add summaries/
          git diff --staged --quiet || git commit -m "Add ${{ inputs.period || 'weekly' }} summary"
          git pull --rebase origin main
          git push

  create-hub-pr:
    needs: generate-summary
    if: ${{ inputs.period == 'weekly' || github.event_name == 'schedule' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull origin main

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Generate news post
        id: news
        run: |
          python scripts/news_post.py
          # Extract week info from latest summary filename
          LATEST=$(ls -1 summaries/weekly/*.md | sort -r | head -1)
          WEEK_INFO=$(basename "$LATEST" .md)
          echo "week_info=$WEEK_INFO" >> $GITHUB_OUTPUT

      - name: Create PR via GitHub API
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          FORK="nekrut/galaxy-hub"
          UPSTREAM="galaxyproject/galaxy-hub"
          BRANCH_NAME="news/galactic-weekly-${{ github.run_id }}"
          WEEK_INFO="${{ steps.news.outputs.week_info }}"

          # Get upstream default branch SHA (no sync needed - branch from upstream directly)
          DEFAULT_BRANCH=$(gh api "repos/${UPSTREAM}" --jq '.default_branch')
          BASE_SHA=$(gh api "repos/${UPSTREAM}/git/ref/heads/${DEFAULT_BRANCH}" --jq '.object.sha')

          # Create new branch on fork
          gh api "repos/${FORK}/git/refs" \
            -f ref="refs/heads/${BRANCH_NAME}" \
            -f sha="${BASE_SHA}"

          # Find the news post file
          NEWS_DIR=$(ls -d news-post/*-galactic-weekly)
          NEWS_FILE="${NEWS_DIR}/index.md"
          DIR_NAME=$(basename "$NEWS_DIR")

          # Upload file content to fork
          CONTENT=$(base64 -i "$NEWS_FILE")
          gh api "repos/${FORK}/contents/content/news/${DIR_NAME}/index.md" \
            -X PUT \
            -f message="Add Galactic Weekly for ${WEEK_INFO}" \
            -f content="${CONTENT}" \
            -f branch="${BRANCH_NAME}"

          # Output branch URL for manual PR creation
          echo "Branch ready: https://github.com/${FORK}/tree/${BRANCH_NAME}"
          echo "Create PR: https://github.com/galaxyproject/galaxy-hub/compare/main...nekrut:galaxy-hub:${BRANCH_NAME}"
